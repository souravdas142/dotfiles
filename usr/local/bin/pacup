#!/bin/sh

# This script is POSIX compliant and should be executable with /bin/sh.
# It is designed to be run with sudo: 'sudo pacup' or 'sudo pacup -u'.

# --- Configuration ---
# The core reflector command without the --age argument.
# We're using a generous but not excessive 10s download timeout.
REFLECTOR_BASE_CMD="reflector --verbose --latest 30 --number 10 -p http -p https -p rsync --sort rate --save /etc/pacman.d/mirrorlist --download-timeout 10"
DEFAULT_AGE="1"

# --- Functions ---

# Function to safely update the mirrorlist with a required age filter.
# $1: age_in_hours (numeric, e.g., "1" or "0.5")
update_mirrorlist_reflector () {
    AGE="$1"

    echo "Updating mirrorlist with age filter: ${AGE} hours"

    if ! command -v reflector > /dev/null 2>&1; then
        echo "[error] 'reflector' not found. Please install it."
        return 1
    fi

    # Run reflector command (no 'sudo' needed here as the main script is run with sudo)
    ${REFLECTOR_BASE_CMD} --age "${AGE}"

    if [ "$?" -ne 0 ]; then
        echo "[error] Mirrorlist update failed. Check internet connection and reflector logs."
        return 1
    fi

    echo "[OK] Mirrorlist update successful (age ${AGE} h)."
    return 0
}

# Function for full system upgrade: calls mirror update and then upgrades
# $1: age_in_hours for reflector
full_system_upgrade () {
    # Step 1: Update Mirrorlist
    update_mirrorlist_reflector "$1"

    if [ "$?" -ne 0 ]; then
        return 1 # Exit if mirrorlist update failed
    fi

    # Step 2: System Upgrade (This is the common part that runs *after* a successful mirror refresh)
    echo "[>>] Starting System Upgrade (pacman -Syy && powerpill -Su --noconfirm)"

    # Re-sync package databases against the new mirrorlist
    pacman -Syy

    # Perform the system upgrade
    powerpill -Su --noconfirm

    if [ "$?" -ne 0 ]; then
        echo "[warning] System upgrade completed with errors."
    else
        echo "[OK] System upgrade successful."
    fi

    return 0
}

# --- Main Logic ---

# Check for root privilege (POSIX compliant id -u)
if test "$(id -u)" -ne 0; then
    echo "[error] Run with sudo or as root: sudo $0 $@"
    exit 1
fi

# Argument Parsing
case "$1" in
    "-u")
        # Case 1: update_mirrors_only (-u)

        # Check if age argument is provided ($2); if not, use default
        if [ -n "$2" ]; then
            MIRROR_AGE="$2"
        else
            MIRROR_AGE="${DEFAULT_AGE}"
        fi

        echo "[--] Starting Mirrorlist Update (Mirror-Only Mode)"
        update_mirrorlist_reflector "${MIRROR_AGE}"
        ;;

    "")
        # Case 2: update_and_upgrades (no arg)
        echo "[--] Starting System Update and Upgrade (Full Mode, Age ${DEFAULT_AGE} h)"
        full_system_upgrade "${DEFAULT_AGE}"
        ;;

    *)
        # Case 3: update_and_upgrades (numeric age arg)

        # Simple POSIX check to see if the argument contains anything other than digits or dots.
        # This is not a perfect float check but prevents most garbage input.
        if echo "$1" | tr -d '0-9.' | grep -q '[^.]'; then
             echo "[error] Invalid argument: '$1'. Age must be a numeric value (e.g., 1 or 0.5)."
             echo "Usage:"
             echo "  pacup           # Full update (age 1h)"
             echo "  pacup <age>     # Full update (custom age)"
             echo "  pacup -u        # Mirrorlist only (age 1h)"
             echo "  pacup -u <age>  # Mirrorlist only (custom age)"
             exit 1
        fi

        MIRROR_AGE="$1"
        echo "[--] Starting System Update and Upgrade (Full Mode, Custom Age $MIRROR_AGE h)"
        full_system_upgrade "${MIRROR_AGE}"
        ;;
esac

exit "$?"

